

{% extends 'user/base.html' %}

{% block title %}Members List{% endblock %}
{% load humanize %}

{% block content %}
<div class="content-page">
  <div class="content">
    <div class="container-fluid mt-4">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Members List</h2>
        <div class="btn-group">
          <a href="{% url 'create_member' %}" class="btn btn-success">
            <i class="ri-add-line"></i> Add New Member
          </a>
          <button type="button" class="btn btn-info" onclick="window.print()">
            <i class="ri-printer-line"></i> Print List
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadPDF()">
            <i class="ri-file-pdf-line"></i> Download PDF
          </button>
        </div>
      </div>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Bulk Email Actions -->
      <div class="row mb-4" id="bulk-actions">
        <div class="col-12">
          <div class="card bg-light">
            <div class="card-body py-3">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <h5 class="mb-0">
                    <i class="ri-mail-line"></i> Bulk Email Actions
                  </h5>
                </div>
                <div class="col-md-6">
                  <div class="d-flex justify-content-end gap-2">
                    {% if expiring_count > 0 %}
                      <a href="{% url 'send_bulk_email' %}?type=expiring" 
                         class="btn btn-warning btn-sm"
                         onclick="return confirm('Send email to {{ expiring_count }} members with expiring certificates?')">
                        <i class="ri-mail-send-line"></i>
                        Send to Expiring ({{ expiring_count }})
                      </a>
                    {% endif %}
                    {% if expired_count > 0 %}
                      <a href="{% url 'send_bulk_email' %}?type=expired" 
                         class="btn btn-danger btn-sm"
                         onclick="return confirm('Send email to {{ expired_count }} members with expired certificates?')">
                        <i class="ri-mail-send-line"></i>
                        Send to Expired ({{ expired_count }})
                      </a>
                    {% endif %}
                    {% if expiring_count == 0 and expired_count == 0 %}
                      <span class="text-muted">
                        <i class="ri-check-line"></i> All certificates are valid
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow" id="members-report">
        <div class="card-header bg-light" id="filters-section">
          <div class="row">
            <div class="col-md-4">
              <div class="input-group">
                <input type="text" id="memberSearch" class="form-control" placeholder="Search members..." value="{{ search_query }}">
                <div class="input-group-append">
                  <button type="button" class="btn btn-primary"><i class="ri-search-line"></i></button>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <select id="statusFilter" class="form-control">
                <option value="">All Certificate Status</option>
                <option value="valid" {% if status_filter == 'valid' %}selected{% endif %}>Valid</option>
                <option value="expiring" {% if status_filter == 'expiring' %}selected{% endif %}>Expiring Soon</option>
                <option value="expired" {% if status_filter == 'expired' %}selected{% endif %}>Expired</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="categoryFilter" class="form-control">
                <option value="">All Categories</option>
                <option value="building_development" {% if category_filter == 'building_development' %}selected{% endif %}>Building Development</option>
                <option value="site_and_services" {% if category_filter == 'site_and_services' %}selected{% endif %}>Site and Services</option>
                <option value="neighbourhood_estate" {% if category_filter == 'neighbourhood_estate' %}selected{% endif %}>Neighbourhood Estate</option>
                <option value="engineering_construction" {% if category_filter == 'engineering_construction' %}selected{% endif %}>Engineering/Construction</option>
                <option value="surveying" {% if category_filter == 'surveying' %}selected{% endif %}>Surveying</option>
                <option value="contractor" {% if category_filter == 'contractor' %}selected{% endif %}>Contractor</option>
                <option value="realtor" {% if category_filter == 'realtor' %}selected{% endif %}>Realtor</option>
                <option value="student" {% if category_filter == 'student' %}selected{% endif %}>Student</option>
              </select>
            </div>
            <div class="col-md-3">
              <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                <i class="ri-refresh-line"></i> Reset Filters
              </button>
            </div>
          </div>
        </div>

        <div class="card-body p-0" id="report-content">
          <!-- Print Header (visible only in print/PDF) -->
          <div class="print-header d-none" style="display: none;">
            <div class="text-center mb-4">
              <h2>REDAN Enugu Members List</h2>
              <p>Generated on: {{ current_date|date:"M d, Y g:i A" }}</p>
              <hr>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover mb-0" id="members-table">
              <thead class="thead-light">
                <tr>
                  <th>Company Name</th>
                  <th>Categories</th>
                  <th class="no-print">RC Number</th>
                  <th class="no-print">MD Phone</th>
                  <th>Certificate Status</th>
                  <th>Expiry Date</th>
                  <th>Days Left</th>
                  <th>National Reg.</th>
                  <th>Enugu Reg.</th>
                  <th class="no-print">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if members %}
                  {% for member in members %}
                    <tr class="member-row" 
                        data-status="{{ member.certificate_status }}" 
                        data-company="{{ member.company_name|lower }}" 
                        data-rc="{{ member.rc_no|lower }}" 
                        data-categories="{{ member.company_categories|lower }}">
                      <td><strong>{{ member.company_name }}</strong></td>
                      <td>
                        {% if member.company_categories %}
                          <div class="category-badges">
                            {% for category in member.get_categories_display %}
                              <span class="badge badge-info badge-sm mr-1 mb-1">{{ category }}</span>
                            {% endfor %}
                          </div>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      <td class="no-print">{{ member.rc_no }}</td>
                      <td class="no-print">{{ member.md_phone_number }}</td>
                      <td>
                        {% if member.certificate_status == 'expired' %}
                          <span class="badge badge-danger status-badge">Expired</span>
                        {% elif member.certificate_status == 'expiring' %}
                          <span class="badge badge-warning status-badge">Expiring Soon</span>
                        {% elif member.certificate_status == 'valid' %}
                          <span class="badge badge-success status-badge">Valid</span>
                        {% else %}
                          <span class="badge badge-secondary status-badge">Unknown</span>
                        {% endif %}
                      </td>
                      <td class="{% if member.is_certificate_expired or member.is_certificate_expiring_soon %}text-danger font-weight-bold{% endif %}">
                        {% if member.certificate_expiry_date %}
                          {{ member.certificate_expiry_date|date:"M d, Y" }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="{% if member.is_certificate_expired or member.is_certificate_expiring_soon %}text-danger font-weight-bold{% endif %}">
                        {% if member.days_until_expiry != None %}
                          {% if member.days_until_expiry < 0 %}
                            Expired {{ member.days_until_expiry|add:"0"|cut:"-" }} days ago
                          {% else %}
                            {{ member.days_until_expiry }} days
                          {% endif %}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if member.national_first_registered %}
                          {{ member.national_first_registered|date:"M d, Y" }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>
                        {% if member.enugu_first_registered %}
                          {{ member.enugu_first_registered|date:"M d, Y" }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="no-print">
                        <div class="btn-group" role="group">
                          <a href="{% url 'member_detail' member.id %}" class="btn btn-sm btn-info" title="View Details">
                            <i class="ri-eye-line"></i>
                          </a>
                          <a href="{% url 'edit_member' member.id %}" class="btn btn-sm btn-warning" title="Edit Member">
                            <i class="ri-edit-line"></i>
                          </a>
                          
                          <!-- Email button for expiring/expired certificates -->
                          {% if member.is_certificate_expired or member.is_certificate_expiring_soon %}
                            {% if member.company_email %}
                              <a href="{% url 'send_individual_email' member.id %}" 
                                 class="btn btn-sm btn-primary" 
                                 title="Send Email Notification"
                                 onclick="return confirm('Send email notification to {{ member.company_name }}?')">
                                <i class="ri-mail-send-line"></i>
                              </a>
                            {% else %}
                              <button class="btn btn-sm btn-secondary" 
                                      title="No email address available" 
                                      disabled>
                                <i class="ri-mail-line"></i>
                              </button>
                            {% endif %}
                          {% endif %}
                          
                          <a href="{% url 'delete_member' member.id %}" class="btn btn-sm btn-danger" title="Delete Member" onclick="return confirm('Are you sure you want to delete this member?')">
                            <i class="ri-delete-bin-line"></i>
                          </a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="10" class="text-center py-4">
                      No members found. <a href="{% url 'create_member' %}" class="no-print">Add your first member</a><span class="print-only d-none">No members found.</span>.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <!-- Print Footer -->
          <div class="print-footer d-none mt-4" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <strong>Total Members: </strong>{{ members|length }}
              </div>
              <div class="col-md-6 text-right">
                <strong>Report Generated: </strong>{{ current_date|date:"M d, Y g:i A" }}
              </div>
            </div>
          </div>
        </div>

        {% if members.has_other_pages %}
        <div class="card-footer bg-white no-print">
          <nav aria-label="Members pagination">
            <ul class="pagination justify-content-center mb-0">
              {% if members.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ members.previous_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">&laquo;</a>
                </li>
              {% endif %}
              {% for num in members.paginator.page_range %}
                {% if members.number == num %}
                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num >= members.number|add:-2 and num <= members.number|add:2 %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}
              {% if members.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ members.next_page_number }}&search={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">&raquo;</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<!-- Add html2pdf library for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
.category-badges {
  max-width: 200px;
}

.badge-sm {
  font-size: 0.75em;
  padding: 0.25em 0.4em;
}

.badge-info {
  background-color: #17a2b8 !important;
  color: #fff !important;
}

.category-badges .badge {
  display: inline-block;
  margin-right: 0.25rem;
  margin-bottom: 0.25rem;
}

/* Enhanced badge styling with explicit colors */
.status-badge.badge-danger {
  background-color: #dc3545 !important;
  color: white !important;
}

.status-badge.badge-warning {
  background-color: #ffc107 !important;
  color: #212529 !important;
}

.status-badge.badge-success {
  background-color: #28a745 !important;
  color: white !important;
}

.status-badge.badge-secondary {
  background-color: #6c757d !important;
  color: white !important;
}

/* Print and PDF specific styles */
@media print {
  /* Hide non-essential elements */
  .btn, .btn-group, #bulk-actions, #filters-section, .no-print, .card-footer {
    display: none !important;
  }
  
  /* Show print-only elements */
  .print-header, .print-footer {
    display: block !important;
  }
  
  .print-only {
    display: inline !important;
  }
  
  /* Page formatting */
  @page {
    size: A4;
    margin: 0.5in;
  }
  
  body {
    font-size: 11px;
    line-height: 1.3;
    color: #000 !important;
  }
  
  /* Card styling for print */
  .card {
    border: 1px solid #000 !important;
    box-shadow: none !important;
    break-inside: avoid;
  }
  
  .card-header {
    background-color: #f8f9fa !important;
    color: #000 !important;
    border-bottom: 2px solid #000 !important;
  }
  
  /* Table styling */
  .table {
    font-size: 10px;
    break-inside: auto;
  }
  
  .table thead {
    break-inside: avoid;
    break-after: auto;
  }
  
  .table tbody tr {
    break-inside: avoid;
    page-break-inside: avoid;
  }
  
  .table thead th {
    background-color: #f8f9fa !important;
    color: #000 !important;
    border: 1px solid #000 !important;
    font-weight: bold;
    padding: 8px 4px;
  }
  
  .table td {
    border: 1px solid #ddd !important;
    padding: 6px 4px;
    color: #000 !important;
  }
  
  /* Badge colors for print - CRITICAL for visibility */
  .badge {
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    print-color-adjust: exact !important;
    border: 1px solid !important;
  }
  
  .status-badge.badge-danger {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
  }
  
  .status-badge.badge-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
    border-color: #ffc107 !important;
  }
  
  .status-badge.badge-success {
    background-color: #28a745 !important;
    color: white !important;
    border-color: #28a745 !important;
  }
  
  .status-badge.badge-secondary {
    background-color: #6c757d !important;
    color: white !important;
    border-color: #6c757d !important;
  }
  
  .badge-info {
    background-color: #17a2b8 !important;
    color: white !important;
    border-color: #17a2b8 !important;
  }
  
  /* Text colors */
  .text-success {
    color: #28a745 !important;
  }
  
  .text-danger {
    color: #dc3545 !important;
  }
  
  .text-warning {
    color: #856404 !important;
  }
  
  /* Prevent widows and orphans */
  p, .table tbody tr {
    orphans: 3;
    widows: 3;
  }
  
  /* Headings */
  h1, h2, h3, h4, h5, h6 {
    break-after: avoid;
    orphans: 3;
    widows: 3;
  }
  
  /* Print header styling */
  .print-header h2 {
    font-size: 18px;
    margin-bottom: 10px;
  }
  
  .print-header p {
    font-size: 12px;
    margin-bottom: 5px;
  }
  
  .print-footer {
    font-size: 10px;
    margin-top: 20px;
    border-top: 1px solid #000;
    padding-top: 10px;
  }
  
  /* Force table to fit page width */
  .table-responsive {
    overflow: visible !important;
  }
  
  /* Adjust column widths for better fit */
  .table th:nth-child(1), .table td:nth-child(1) { width: 25%; } /* Company Name */
  .table th:nth-child(2), .table td:nth-child(2) { width: 15%; } /* Categories */
  .table th:nth-child(3), .table td:nth-child(3) { width: 12%; } /* Certificate Status */
  .table th:nth-child(4), .table td:nth-child(4) { width: 12%; } /* Expiry Date */
  .table th:nth-child(5), .table td:nth-child(5) { width: 12%; } /* Days Left */
  .table th:nth-child(6), .table td:nth-child(6) { width: 12%; } /* National Reg */
  .table th:nth-child(7), .table td:nth-child(7) { width: 12%; } /* Enugu Reg */
}

/* Screen-only styles */
@media screen {
  .print-header, .print-footer {
    display: none !important;
  }
  
  .print-only {
    display: none !important;
  }
}
</style>

<script>
function filterMembers() {
  const searchValue = document.getElementById('memberSearch').value.toLowerCase();
  const statusFilter = document.getElementById('statusFilter').value;
  const categoryFilter = document.getElementById('categoryFilter').value;
  
  document.querySelectorAll('.member-row').forEach(row => {
    const company = row.dataset.company || '';
    const rc = row.dataset.rc || '';
    const status = row.dataset.status;
    const categories = row.dataset.categories || '';
    
    let show = company.includes(searchValue) || rc.includes(searchValue);
    if (show && statusFilter && status !== statusFilter) show = false;
    if (show && categoryFilter && !categories.includes(categoryFilter.toLowerCase())) show = false;
    
    row.style.display = show ? '' : 'none';
  });
}

function resetFilters() {
  document.getElementById('memberSearch').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('categoryFilter').value = '';
  
  // Show all rows
  document.querySelectorAll('.member-row').forEach(row => {
    row.style.display = '';
  });
  
  // Also reset the URL parameters
  const url = new URL(window.location);
  url.searchParams.delete('search');
  url.searchParams.delete('status');
  url.searchParams.delete('category');
  url.searchParams.delete('page');
  window.location.href = url.toString();
}

function applyFilters() {
  const search = document.getElementById('memberSearch').value;
  const status = document.getElementById('statusFilter').value;
  const category = document.getElementById('categoryFilter').value;
  const url = new URL(window.location);
  
  if (search) {
    url.searchParams.set('search', search);
  } else {
    url.searchParams.delete('search');
  }
  
  if (status) {
    url.searchParams.set('status', status);
  } else {
    url.searchParams.delete('status');
  }
  
  if (category) {
    url.searchParams.set('category', category);
  } else {
    url.searchParams.delete('category');
  }
  
  url.searchParams.delete('page');
  window.location.href = url.toString();
}

// PDF Download function
function downloadPDF() {
  // Show print elements temporarily for PDF generation
  const printHeader = document.querySelector('.print-header');
  const printFooter = document.querySelector('.print-footer');
  
  printHeader.style.display = 'block';
  printFooter.style.display = 'block';
  
  const element = document.getElementById('report-content');
  
  const opt = {
    margin: 0.3,
    filename: 'REDAN_Members_List_{{ current_date|date:"Y_m_d_His" }}.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2, 
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    },
    jsPDF: { 
      unit: 'in', 
      format: 'a4', 
      orientation: 'landscape' // Better for wide tables
    },
    pagebreak: { 
      mode: ['avoid-all', 'css', 'legacy'],
      before: '.page-break-before',
      after: '.page-break-after',
      avoid: '.member-row'
    }
  };

  html2pdf().set(opt).from(element).save().then(() => {
    // Hide print elements after PDF generation
    printHeader.style.display = 'none';
    printFooter.style.display = 'none';
  });
}

document.getElementById('memberSearch').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    applyFilters();
  } else {
    filterMembers();
  }
});

document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('categoryFilter').addEventListener('change', applyFilters);

// Set current date for template context
document.addEventListener('DOMContentLoaded', function() {
  // This ensures the date is available for the PDF filename
  if (!window.current_date) {
    window.current_date = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
  }
});
</script>
{% endblock %}